@page "/"
@rendermode InteractiveServer
@using FinancialPlanner.Blazor.Components.Models
@using FinancialPlanner.Blazor.DataAccess
@using FinancialPlanner.Blazor.DataAccess.Models
@using Microsoft.EntityFrameworkCore
@using static FinancialPlanner.Blazor.DataAccess.Helpers.Enums
@inject FinanceDbContext DbContext

<h3>Finance Planner - Months Overview</h3>

<h4>Bank Balance: @bankBalanceForToday.ToString("C") for Today: @today.Date.ToShortDateString()  </h4>

@if (expendituresBeforeMonthEnd.Any())
{
    <h5>Expenditures before end of this month: £@expendituresBeforeMonthEnd.Sum(expenditures => expenditures.Amount).ToString("F2")</h5>
    <ul>
        @foreach (var exp in expendituresBeforeMonthEnd)
        {
            <li>
                @exp.Amount.ToString("C") - @exp.Name (day @exp.Date.Day)
            </li>
        }
    </ul>
    <h5>Expenditures already paid: £@expendituresPaidByToday.Sum(expenditures => expenditures.Amount).ToString("F2")</h5>
    <ul>
        @foreach (var exp in expendituresPaidByToday)
        {
            <li>
                @exp.Amount.ToString("C") - @exp.Name (day @exp.Date.Day)
            </li>
        }
    </ul>

}

@if (monthDtos == null)
{
    <p>Loading...</p>
}
else if (!monthDtos.Any())
{
    <p>No months found.</p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Month Name</th>
                <th>End Date</th>
                <th>Total Income</th>
                <th>Total Expenditure</th>
                <th>Savings</th>
                <th>Notes</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var month in monthDtos)
            {
                <tr>
                    <td>@month.Name</td>
                    <td>@month.EndDate.ToShortDateString()</td>
                    <td>£@month.TotalIncome</td>
                    <td>£@month.TotalExpenditure</td>
                    <td>£@month.Savings</td>
                </tr>
                <tr>
                    <td colspan="7">
                        <strong>Category Expenditure as % of Total Income:</strong>
                        <ul class="mb-2">
                            @foreach (var cat in GetCategoryPercentages(month))
                            {
                                <li>
                                    @cat.Category: @cat.Amount.ToString("C") (@cat.Percentage.ToString("F2")%)
                                    @if (cat.Category != "Leftover" && cat.Category != "Total")
                                    {
                                        var exps = month.Expenditures
                                        .Where(e => e.Category.ToString() == cat.Category)
                                        .ToList();

                                        if (exps.Any())
                                        {
                                            <span> - </span>
                                            <span>
                                                @foreach (var exp in exps)
                                                {
                                                    <span>
                                                        @exp.Name (day @exp.Date.Day)
                                                        @(exp != exps.Last() ? ", " : "")
                                                    </span>
                                                }
                                            </span>
                                        }
                                    }
                                </li>
                            }
                        </ul>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<Month>? DbMonths;
    private List<ExpenditureDto>? expenditures;
    private List<ExpenditureDto> expendituresBeforeMonthEnd = new();
    private List<ExpenditureDto> expendituresPaidByToday = new();
    private decimal bankBalanceForToday;
    private DateTime today;
    private List<MonthDto> monthDtos;

    protected override async Task OnInitializedAsync()
    {
        monthDtos = new();
        today = DateTime.Today;

        DbMonths = await DbContext.Months
        .Where(month => month.EndDate >= today)
        .OrderBy(m => m.StartDate)
        .ToListAsync();

        var expenditureDb = await DbContext.Expenditures.ToListAsync();

        expenditures = expenditureDb.Select(exp => new ExpenditureDto
            {
                Id = exp.Id,
                Name = exp.Name,
                Amount = exp.Amount,
                Date = exp.Date,
                StartDate = exp.StartDate,
                EndDate = exp.EndDate,
                Recurring = exp.Recurring,
                Category = exp.Category
            }).ToList();    

        var monthlyIncome = await DbContext.Incomes
                .Where(i => i.Date.Day <= today.Day)
                .SumAsync(i => (decimal?)i.Amount) ?? 0;

        var totalExpenditure = await DbContext.Expenditures
            .Where(e => e.Date <= today)
            .SumAsync(e => (decimal?)e.Amount) ?? 0;


        foreach (var month in DbMonths)
        {
            var monthDto = new MonthDto
                {
                    Name = month.Name,
                    StartDate = month.StartDate,
                    EndDate = month.EndDate,
                    Savings = month.Savings,
                    TotalExpenditure = month.TotalExpenditure,
                    TotalIncome = month.TotalIncome,
                };

            monthDto.Expenditures = GetExpendituresForMonth(monthDto)
               .ToList();

            monthDto.TotalExpenditure = monthDto.Expenditures.Sum(e => e.Amount);
            monthDto.TotalIncome = await DbContext.Incomes
                .Where(i => ((i.Recurring && (i.StartDate <= monthDto.StartDate) && (i.EndDate >= monthDto.EndDate))) || (!i.Recurring && (i.StartDate >= monthDto.StartDate) && (i.StartDate <= monthDto.EndDate)))
                .SumAsync(i => (decimal?)i.Amount) ?? 0;

            monthDto.Savings = monthDto.TotalIncome - monthDto.TotalExpenditure;

            if (month.StartDate.Date <= today.Date && month.EndDate.Date >= today.Date)
            {
                //we are on this month
                var foodBudget = monthDto.Expenditures.Where(e => e.Category == Category.Groceries).Sum(e => e.Amount);
                var daysInMonth = DateTime.DaysInMonth(today.Year, today.Month);

                var dailyFoodBudget = foodBudget / daysInMonth;

                expendituresPaidByToday.Add(new ExpenditureDto
                    {
                        Name = "Food Budget Used",
                        Amount = dailyFoodBudget * today.Day,
                        Date = today,
                        StartDate = monthDto.StartDate,
                        EndDate = monthDto.EndDate,
                        Recurring = false,
                        Category = Category.Groceries
                    });

                expendituresBeforeMonthEnd.Add(new ExpenditureDto
                    {
                        Name = "Food Budget Remaining",
                        Amount = dailyFoodBudget * (daysInMonth - today.Day),
                        Date = today,
                        StartDate = monthDto.StartDate,
                        EndDate = monthDto.EndDate,
                        Recurring = false,
                        Category = Category.Groceries
                    });

                foreach (var exp in monthDto.Expenditures.OrderBy(r => r.StartDate!.Value.Day))
                {
                    if (exp.Date.Day > today.Date.Day && exp.Date.Day <= monthDto.EndDate.Day)
                    {
                        if (exp.Category != Category.Groceries)
                        {
                            expendituresBeforeMonthEnd.Add(exp);
                        }
                    }
                    else if (exp.Date.Day <= today.Date.Day && exp.Date.Day >= monthDto.StartDate.Day)
                    {
                        if (exp.Category != Category.Groceries)
                        {
                            expendituresPaidByToday.Add(exp);
                        }
                    }
                }

                bankBalanceForToday = monthDto.TotalIncome - expendituresPaidByToday.Sum(e => e.Amount);

            }

            monthDtos.Add(monthDto);
        }
    }

    private List<(string Category, decimal Percentage, decimal Amount)> GetCategoryPercentages(MonthDto month)
    {
        var expendituresForMonth = GetExpendituresForMonth(month).ToList();
        var totalIncome = month.TotalIncome;

        // Group expenditures by category
        var categoryGroups = expendituresForMonth
            .GroupBy(e => e.Category)
            .Select(g => new
            {
                Category = g.Key.ToString(),
                Amount = g.Sum(e => e.Amount)
            })
            .ToList();

        decimal totalExpenditure = categoryGroups.Sum(g => g.Amount);

        var results = new List<(string Category, decimal Percentage, decimal Amount)>();

        // Calculate percentage of total income for each category
        foreach (var group in categoryGroups)
        {
            var percent = totalIncome > 0 ? (group.Amount / totalIncome) * 100 : 0;
            results.Add((group.Category, Math.Round(percent, 2), group.Amount));
        }

        // Add leftover category
        var leftoverAmount = totalIncome - totalExpenditure;
        var leftoverPercent = totalIncome > 0 ? (leftoverAmount / totalIncome) * 100 : 0;
        results.Add(("Leftover", Math.Round(leftoverPercent, 2), leftoverAmount));

        // Add total category
        var totalPercent = results.Sum(r => r.Percentage);
        var totalAmount = results.Sum(r => r.Amount);
        results.Add(("Total", Math.Round(totalPercent, 2), totalAmount));

        return results;
    }

    private decimal GetBankBalanceForToday()
    {
        // Get all incomes and expenditures up to and including today
        var today = DateTime.Today;

        var allIncomes = DbContext.Incomes
            .Where(i => i.Date <= today);

        var allExpenditures = DbContext.Expenditures
            .Where(e => e.Date <= today);

        // Calculate totals
        var totalIncome = allIncomes.Any() ? allIncomes.Sum(i => i.Amount) : 0;
        var totalExpenditure = allExpenditures.Any() ? allExpenditures.Sum(e => e.Amount) : 0;

        return totalIncome - totalExpenditure;
    }

    private IEnumerable<ExpenditureDto> GetExpendituresForMonth(MonthDto month)
    {
        if (expenditures == null)
            return Enumerable.Empty<ExpenditureDto>();

        return expenditures.Where(exp =>
           ((exp.Recurring && (exp.StartDate <= month.StartDate && exp.EndDate >= month.EndDate)) || (!exp.Recurring && (exp.StartDate >= month.StartDate && exp.StartDate <= month.EndDate))));
    }

    private async Task DeleteMonth(int id)
    {
        try
        {
            var month = await DbContext.Months
        .FirstOrDefaultAsync(m => m.Id == id);

            if (month != null)
            {
                DbContext.Months.Remove(month);
                await DbContext.SaveChangesAsync();
                DbMonths = await DbContext.Months.ToListAsync();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"{ex.Message}");
        }
    }
}
